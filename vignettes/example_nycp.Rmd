---
title: "Example: New York City Extreme Rainfall"
author: "Enrico Zorzetto"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{example_nycp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(hbevr)
library(rstan)
library(nleqslv)
library(extraDistr)
library(ggplot2)
# library(tidyr)
# library(dplyr)
# library(gridExtra)
library(rstan)
library(bayesplot)
rstan_options(auto_write = TRUE)
```

# Analyze New York City rainfall data

We show an example of application fitting various extreme value distributions
to the NYCP dataset

## read data

```{r}
df = nycp
plot(df$DATE, df$PRCP)
```


## Tunable quantities for this analysis

### Parameters for the HMC sampler

The burn-in period is fixed to 1/2 of the sampling

thresh_hbev -> threshold for determining non-zero rainfall events
 
```{r}
iter = 2000 # number of iterations for each chain
chains = 4  # number of chains
ndraws = iter*chains/2 # total number of draws from the posterior
thresh_hbev = 0
adapt_delta = 0.8
corr_signif_lim = 0.05
trmin = 5 
Mgen = 50
Nt = 366 # number of events / year
```


compute some basic statistics, such as the observed frequency of extremes
```{r}
res = table_max(df, Nt=Nt)

plot(res$Tr, res$Xi)
```


compute some basic statistics, such as the observed frequency of extremes
```{r}
Mcal = 10 # length of the sample used for fitting
fliptime =TRUE # to select it from the end of the dataset
# first 50 years of the time series
datasets = split_obs_data(df, M_cal = Mcal,
                           M_val = 270,  # all data for validation
                           Nt = 366,
                           cross_val = FALSE, 
                           reshuffle = TRUE, 
                           flip_time = fliptime,
                           reshuffle_days = FALSE,
                           decluster = FALSE,
                           signif_lim = corr_signif_lim)

data = datasets$datacal$data # daily data for model fitting
maxima = datasets$dataval$max # annualmaxima for model checking
```

Fit the HBEV extreme value model
```{r}
dynfit <- fit_ev_model(data, model = 'wei_dyn_bin', iter = iter, chains=chains , 
           Mgen = Mgen, adapt_delta = adapt_delta, thresh_hbev = thresh_hbev, refresh = 400)


stafit <- fit_ev_model(data, model = 'wei_sta_bin', iter = iter, chains=chains , 
           Mgen = Mgen, adapt_delta = adapt_delta, thresh_hbev = thresh_hbev, refresh = 400)


```

Compute extreme value quantiles from the fitted model, and compute some 
goodness of fit measures based on the validation data
```{r}
dynq <- comp_quant(dynfit, maxima, trmin = trmin)
staq <- comp_quant(stafit, maxima, trmin = trmin)

print(dynq$lppd)
print(dynq$lpml)
print(dynq$fse)
print(dynq$mbias)
```

```{r}

p1 <- ggplot() +
  geom_point(aes( res$Tr, res$Xi),  size = 3, color = "orange", shape = 1) +
  geom_point(aes( datasets$datacal$Tr, datasets$datacal$Xi),  size = 3, color = "cyan", shape = 2) +
  geom_point(aes( datasets$dataval$Tr, datasets$dataval$Xi),  size = 3, color = "black", shape = 3) +
  
  geom_line(aes(  staq$TrvalQ, staq$qmean),  linetype="solid", color="green") +
  geom_line(aes(  staq$TrvalQ, staq$qupper), linetype="dashed",color="green") +
  geom_line(aes(  staq$TrvalQ, staq$qlower), linetype="dashed",color="green") +
  # # # 
  geom_line(aes(  dynq$TrvalQ, dynq$qmean),  linetype="solid",color= "blue") +
  geom_line(aes(  dynq$TrvalQ, dynq$qupper), linetype="dashed",color="blue") +
  geom_line(aes(  dynq$TrvalQ, dynq$qlower), linetype="dashed",color="blue") +

coord_trans(x="log10", y = 'log10') +
  labs(y = "Quantile [mm/day]", x= "Return Time [years]") +
  theme_bw()
p1
p2 <- ggplot() +
  geom_point(aes( res$Xi, res$Fi),  size = 3, color = "orange", shape = 1) +
  geom_point(aes( datasets$datacal$Xi, datasets$datacal$Fi),  size = 3, color = "cyan", shape = 2) +
  geom_point(aes( datasets$dataval$Xi, datasets$dataval$Fi),  size = 3, color = "black", shape = 3) +

  geom_line(aes(  dynq$Xival, dynq$fupper), linetype="dashed",color="blue") +
  geom_line(aes(  dynq$Xival, dynq$fmean),  linetype="solid",color= "blue") +
  geom_line(aes(  dynq$Xival, dynq$flower), linetype="dashed",color="blue") +
  # 
  geom_line(aes(  staq$Xival, staq$fmean),  linetype="solid",color= "green") +
  geom_line(aes(  staq$Xival, staq$fupper), linetype="dashed",color="green") +
  geom_line(aes(  staq$Xival, staq$flower), linetype="dashed",color="green") +

coord_trans(x="log10") +
  labs(y = "P(X < x)", x= "Quantile x [mm/day]") +
  theme_bw()
p2
# fig <- grid.arrange(p1, p2, ncol=2)
```

Another function from the package to plot quantiles:
```{r}
clrs <- color_scheme_get("brightblue")



listq = list(dynq, staq)
fig1 = plot_quants(listq)
plot(fig1)


```

And at last a function to plot the posterior predictive distributions for some quantities
```{r}

fig2 <- plot_ppd_pdfs(dynfit, datasets$datacal$data, ndraws2plot = 50)
plot(fig2)
# ggsave(file.path(outplot, 'example_ppdf_pdf.png'), plot=fig2, device = 'png',
#                        width = 14, height = 6)
```

