---
title: "prior_sensitivity"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{prior_sensitivity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(hmevr)
library(rstan)
library(nleqslv)
library(extraDistr)
library(ggplot2)
# library(tidyr)
# library(dplyr)
library(gridExtra)
library(rstan)
library(bayesplot)
rstan_options(auto_write = TRUE)
```

# Analyze prior sensitivity

## read data

```{r}
df = nycp
plot(df$DATE, df$PRCP)
```


Tunable quantities for this analysis and parameters for the HMC sampler
The burn-in period is fixed to 1/2 of the sampling

 
```{r}
iter = 2000 # number of iterations for each chain
chains = 4  # number of chains
ndraws = iter*chains/2 # total number of draws from the posterior
thresh_hbev = 0
adapt_delta = 0.8
corr_signif_lim = 0.1
trmin = 5 
Mgen = 50
Nt = 366 # number of events / year
```


compute some basic statistics, such as the observed frequency of extremes
```{r}
res = table_max(df, Nt=Nt)

plot(res$Tr, res$Xi)
```


compute some basic statistics, such as the observed frequency of extremes
```{r}
Mcal1 = 20 # length of the sample used for fitting
Mcal2 = 50 # length of the sample used for fitting
fliptime =FALSE # to select it from the end of the dataset
reshuffle = FALSE
# first 50 years of the time series
datasets1 = split_obs_data(df, M_cal = Mcal1,
                           M_val = 270,  # all data for validation
                           Nt = 366,
                           cross_val = FALSE, 
                           reshuffle = reshuffle, 
                           flip_time = fliptime,
                           reshuffle_days = FALSE,
                           decluster = FALSE,
                           signif_lim = corr_signif_lim)

datasets2 = split_obs_data(df, M_cal = Mcal2,
                           M_val = 270,  # all data for validation
                           Nt = 366,
                           cross_val = FALSE, 
                           reshuffle = reshuffle, 
                           flip_time = fliptime,
                           reshuffle_days = FALSE,
                           decluster = FALSE,
                           signif_lim = corr_signif_lim)

data1 = datasets1$datacal$data # daily data for model fitting
maxima1 = datasets1$dataval$max # annualmaxima for model checking

data2 = datasets2$datacal$data # daily data for model fitting
maxima2 = datasets2$dataval$max # annualmaxima for model checking
```

Fit the HBEV extreme value model

Let us compare the static and dynamic hbev models with p(n) binomial,
and a dynamic model with p(n) beta-binomial (i.e., the binomial rate is also changing year to year)
```{r}
modelname = 'wei_dgu_bin'
dynfit1 <- fit_ev_model(data1, model = modelname, iter = iter, chains=chains , 
           Mgen = Mgen, adapt_delta = adapt_delta, thresh_hbev = thresh_hbev, 
           draw_prior = TRUE, refresh = 0)

dynfit2 <- fit_ev_model(data2, model = modelname, iter = iter, chains=chains , 
           Mgen = Mgen, adapt_delta = adapt_delta, thresh_hbev = thresh_hbev, 
           draw_prior = TRUE, refresh = 0)
params = c("mc", "sc", "mw", "sw", "pn")
# dbbfit <- fit_ev_model(data, model = 'wei_dgu_bbn', iter = iter, chains=chains ,
#            Mgen = Mgen, adapt_delta = adapt_delta, thresh_hbev = thresh_hbev, refresh = 0)
# 
# stafit <- fit_ev_model(data, model = 'wei_sta_bin', iter = iter, chains=chains ,
#            Mgen = Mgen, adapt_delta = adapt_delta, thresh_hbev = thresh_hbev, refresh = 0)


```


```{r}
get_priorpost <- function(dynfit, params, ssize){
  dynsim0 <- rstan::extract(dynfit$model_fit)
  priorsim <- as.data.frame(dynfit$prior$prior_rng)
  mynames <- colnames(priorsim)
  renamer <- function(x){ gsub("0prior", "", x ) }
  newnames <- lapply(mynames, renamer) 
  colnames(priorsim) <- newnames
  priorsim[['type']] = 'prior'
  # if ('alphaps' %in% names(mixsim0)){
  #   # colnames(mixsim0)[colnames() == "foo"] <- "bar"
  #   mixsim0[['rho']] <- mixsim0[['alphaps']]
  # } 
  dynsim = as.data.frame(dynsim0[params])
  dynsim[['type']] = sprintf('post: %s years', ssize)
  # mixsim[['ssize']] = ssize
  df = reshape2::melt(rbind(priorsim, dynsim), 
                      id.vars= c("type"),
                      variable.name = 'param',
                      value.name = 'value')
  return(df)
}

df1 = get_priorpost(dynfit1, params, Mcal1)
df1[['case']] <-  'A'
df2 = get_priorpost(dynfit2, params, Mcal1)
df2[['case']] <-  'B'
df = rbind(df1, df2)


  # df = reshape2::melt(rbind(priorsim, mixsim), 
  #                     id.vars= c("case"),
  #                     variable.name = 'param',
  #                     value.name = 'value')

fig <- ggplot(df) +
  # geom_histogram(aes(x=value, color = type)) +
  geom_density(aes(x=value, color = type, linetype=case)) +
  # coord_trans(x="log10") +
  # scale_x_continuous(trans='log10') +
  facet_wrap('param', scales = 'free') 
  
  fig
  # figname = file.path('..', 'output', 'outplot', sprintf('prior_sens_%s_%s', modelname, ssize))
  # ggsave(figname, plot=fig, device = 'png')


```
